---
title: 存储提供商
description: Afilmory 可以与多种存储提供商配合使用，包括 S3、Git 和本地文件系统
createdAt: 2025-08-12T15:09:08+08:00
lastModified: 2025-09-14T19:54:27+08:00
---

# 存储提供商

Afilmory 的灵活存储架构允许您跨不同平台存储照片。照片处理引擎 (`@afilmory/builder`) 通过统一接口抽象存储操作，使切换提供商变得简单。

## 支持的提供商

### S3 兼容存储

S3 兼容存储是生产部署的推荐选项，提供可扩展性、CDN 集成和可靠性能。

**在 `builder.config.json` 中的配置：**

```json
{
  "storage": {
    "provider": "s3",
    "bucket": "your-photos-bucket",
    "region": "us-east-1",
    "prefix": "photos/",
    "customDomain": "cdn.yourdomain.com"
  }
}
```

**环境变量 (`.env`)：**

```bash
S3_ACCESS_KEY_ID=your_access_key_id
S3_SECRET_ACCESS_KEY=your_secret_access_key
```

### GitHub 存储

GitHub 存储利用 Git 仓库存储照片，非常适合静态站点、小型图库或需要照片版本控制的场景。

**特点：**
- ✅ 免费存储空间（GitHub 仓库限制 1GB）
- ✅ 通过 raw.githubusercontent.com 提供全球 CDN 支持
- ✅ 照片版本控制
- ✅ 无需身份验证的公共访问
- ⚠️ 受 GitHub API 速率限制
- ⚠️ 不适合大文件或频繁更新

**在 `builder.config.json` 中的配置：**

```json
{
  "storage": {
    "provider": "github",
    "github": {
      "owner": "your-username",
      "repo": "photo-storage",
      "branch": "main",
      "path": "photos",
      "useRawUrl": true
    }
  }
}
```

**环境变量：**

```bash
GIT_TOKEN=ghp_your_github_personal_access_token
```

**设置步骤：**

1. **创建 GitHub 仓库**
   ```bash
   git clone https://github.com/your-username/photo-gallery.git
   cd photo-gallery
   mkdir photos
   ```

2. **获取 GitHub 访问令牌**（可选但推荐）
   - 访问 GitHub 设置 > 开发者设置 > 个人访问令牌
   - 创建新的细粒度个人访问令牌
   - 授予仓库的 "Contents" 权限（读写）

3. **所需权限：**
   - `Contents: Read and write` - 用于上传处理后的照片
   - `Metadata: Read` - 用于仓库访问

### 本地文件系统

本地存储适用于开发、测试或自托管部署，其中照片存储在同一服务器上。

**特点：**
- ✅ 无外部依赖
- ✅ 访问速度快
- ✅ 完全私有控制
- ✅ 递归目录扫描
- ✅ Live Photos 检测支持
- ⚠️ 需要适当的文件系统权限
- ⚠️ 不适合分布式部署

**在 `builder.config.json` 中的配置：**

```json
{
  "storage": {
    "provider": "local",
    "basePath": "./photos",
    "baseUrl": "http://localhost:3000/photos/"
  }
}
```

## 照片处理工作流

### 图像处理流水线

处理照片时，Afilmory 执行以下操作：

1. **格式检测** - 识别 HEIC、TIFF、RAW 和标准格式
2. **EXIF 提取** - 提取相机元数据、GPS 数据和富士胶片配方
3. **格式转换** - 将 HEIC/TIFF 转换为网络兼容格式（WebP、JPEG）
4. **缩略图生成** - 创建多种缩略图尺寸
5. **Blurhash 生成** - 创建占位图像以实现平滑加载
6. **清单创建** - 为图库生成元数据 JSON

### 存储组织

Afilmory 按以下结构在存储中组织文件：

```
photos/
├── 2024/
│   ├── 01-january/
│   │   ├── IMG_001.jpg
│   │   ├── IMG_001.mov      # Live Photo 视频
│   │   └── IMG_002.heic
│   └── 02-february/
│       └── sunset.jpg
├── 2023/
│   └── vacation/
│       ├── beach.jpg
│       └── mountain.png
└── manifest.json            # 照片元数据和索引
```

### 处理命令

使用这些命令管理照片处理：

```bash
# 初始照片处理
pnpm run build:manifest

# 强制重建所有照片
pnpm run build:manifest -- --force

# 仅重新生成缩略图
pnpm run build:manifest -- --force-thumbnails

# 处理特定目录
pnpm run build:manifest -- --path "2024/vacation"
```

## 环境特定配置

### 开发设置

对于本地开发，使用本地存储：

```json
{
  "storage": {
    "provider": "local",
    "basePath": "./dev-photos",
    "baseUrl": "http://localhost:1924/photos"
  }
}
```

### 生产设置

对于生产环境，使用带 CDN 的 S3 兼容存储：

```json
{
  "storage": {
    "provider": "s3",
    "bucket": "prod-photos-bucket",
    "region": "us-east-1",
    "prefix": "photos/",
    "customDomain": "cdn.yourdomain.com"
  },
  "performance": {
    "worker": {
      "enabled": true,
      "maxWorkers": 4
    }
  }
}
```

## API 限制

### GitHub 存储限制

- **未认证请求**：每小时/每 IP 60 个请求
- **已认证请求**：每小时/每令牌 5,000 个请求
- **文件大小**：最大 100MB（通过 API）
- **仓库大小**：建议不超过 1GB

### 存储提供商比较

| 功能 | S3 | GitHub | 本地 |
|------|----|--------|------|
| 存储空间 | 按需付费 | 免费 1GB | 取决于磁盘 |
| CDN | 额外费用 | 免费全球 CDN | 手动设置 |
| API 限制 | 非常高 | 有限 | 无 |
| 使用场景 | 生产环境 | 小型项目、演示 | 开发、自托管 |
| 设置复杂度 | 中等 | 简单 | 最小 |

## 安全考虑

### S3 存储桶策略

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::your-bucket/photos/*"
    }
  ]
}
```

### GitHub 仓库设置

- 将仓库设置为公开以访问图像
- 使用细粒度个人访问令牌
- 将令牌权限限制到特定仓库

### 环境变量

安全存储敏感凭证：

```bash
# 使用环境特定的 .env 文件
# .env.production
S3_ACCESS_KEY_ID=prod_access_key
S3_SECRET_ACCESS_KEY=prod_secret_key

# .env.development  
S3_ACCESS_KEY_ID=dev_access_key
S3_SECRET_ACCESS_KEY=dev_secret_key
```